---
author: mithro
categories:
- tp
date: 2007-07-23T03:06:02+1000
excerpt: For something a bit different, I decided to work on making embedding Scheme
  in Python easier. I’ve previously been using the cool PyScheme, however it hasn’t
  been updated in quite a long time (since.....
layout: post
permalink: /archives/tp/45-schemepy
title: Skimpy, Scheme in Python
wordpress_category: tp
wordpress_id: 45
wordpress_url: https://blog.mithis.net/archives/tp/45-schemepy
---

<div >
<p>For something a bit different, I decided to work on making embedding <a href="http://www.schemers.org/">Scheme</a> in <a href="http://www.python.org/" title="Python">Python</a> easier. I’ve previously been using the cool <a href="http://http://hkn.eecs.berkeley.edu/~dyoo/python/pyscheme/" title="PyScheme">PyScheme</a>, however it hasn’t been updated in quite a long time (since 2004) and is quite slow.</p>
<p>The reason I would want to do something crazy like this is that <a href="http://www.thousandparsec.net/">Thousand Parsec</a> use a subset of Scheme called <a href="http://www.thousandparsec.net/tp/dev/documents/ncl.php" title="TPCL">TPCL</a>. The is used to transmit information from the server to clients about rules for creating designs. Servers also need to be able to parse <a href="http://www.thousandparsec.net/tp/dev/documents/ncl.php" title="TPCL">TPCL</a> for “dumb clients” which can’t parse <a href="http://www.thousandparsec.net/tp/dev/documents/ncl.php" title="TPCL">TPCL</a> for themselves.</p>
<p>Recent developments by <a href="http://dystopicfro.blogspot.com/index.html" title="Fro's Blog">DystopicFro</a> on his <a href="http://code.google.com/soc" title="Summer of Code">Summer of Code</a> project, a <a href="http://git.thousandparsec.net/gitweb/gitweb.cgi?p=tpruledev.git;a=summary">Ruleset</a><a href="http://git.thousandparsec.net/gitweb/gitweb.cgi?p=tpruledev.git;a=summary"> Development Environment</a> have meant that he also needs the ability to parser <a href="http://www.thousandparsec.net/tp/dev/documents/ncl.php" title="TPCL">TPCL</a> (and specifically the ability to detect errors). This got us chatting about PyScheme and it’s inadequacies.</p>
<p>What I have decided to do is create a module called <a href="http://git.thousandparsec.net/gitweb/gitweb.cgi?p=schemepy.git;a=summary">SchemePy</a> (pronounced Skimpy). On platforms where speed is of no concern, we will fall back to using a modified version of PyScheme. However, we can also use C scheme systems such as <a href="http://www.gnu.org/software/guile/guile.html" title="Guile">Guile</a> (or other libraries) to improve speed.</p>
<p>Why have multiple implementations? It stops us from using custom things in one scheme implementation which are not compatible with other implementations. It also makes installation easier for the user, as they are much more likely to already have a compatible scheme library installed. Different scheme’s also have different speed advantages.</p>
<p>So far I have got the <a href="http://www.gnu.org/software/guile/guile.html" title="Guile">Guile</a> wrapper 95% working. It’s written mainly in <a href="http://www.python.org/" title="Python">Python</a> using <a href="http://python.net/crew/theller/ctypes/" title="Ctypes">ctypes</a>. I needed a small C helper module as well because of the extensive Macro’s used by Guile. So far, you can convert between Guile and Python types easily, you can register Python functions into the Guile context and exceptions are caught. There is also the ability to pass  python objects thru the Scheme environment to Python functions. I would like to thank the guys who hang out on <a href="irc://irc.freenode.org/#guile">#guile</a> for all their help, it has made doing this wrapper much easier.</p>
<p>I’m happy enough with the outcome. My guess it will be between 10 and 20 times faster then PyScheme, but I’ve yet to do any benchmarking. I’m going to move to wrapping <a href="http://www.plt-scheme.org/software/mzscheme/">mzscheme</a> too soon enough. It should be much easier to do now that I have gotten most of the hard stuff sorted out. I think a lot of it will be common between the implementations.</p>
<p>What I really need to do is get a test-suit working. Once I have more then one implementation working  it will be very important to make sure that they all work the same way, the only way I can see to do that properly is to have a test suite which I can run every implementation against.</p>
<p>One thing which might be really cool to investigate is using a similar system to <a href="http://web.archive.org/web/20040607171956/http://www.caddr.com/code/lython/">lython</a> which compiles Lisp <a href="http://en.wikipedia.org/wiki/Sexp">s-expressions</a> directly to python byte code. If this was done well it should be the fastest method as it would mean no type conversion needs to be done.</p>
<p>Overall this has been quite a good learning experience. I have improve my ctype skills quite a lot (this wasn’t my first ctypes wrapper, that being <a href="http://git.thousandparsec.net/repos/libmng-py/doc/" title="libmng-py">libmng-py</a>, a Python wrapper around <a href="http://www.libmng.com/">libmng</a>). I also understand how <a href="http://www.schemers.org/">Scheme</a> works quite a lot better now.</p>
</div>